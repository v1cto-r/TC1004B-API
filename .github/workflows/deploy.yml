name: CI & CD Pipeline

on:
  # 1. Trigger on pushes (merges) to the 'main' branch
  push:
    branches:
      - main
      
  # 2. Trigger on Pull Requests targeting the 'main' branch
  pull_request:
    branches:
      - main

jobs:
  ########################################
  #  CI Job: Build & Test on Pull Request
  ########################################
  build:
    runs-on: ubuntu-latest
    # Only run this job for Pull Requests
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for 'api'
        run: |
          # We build the 'api' service to ensure the Dockerfile works
          # We don't need to build 'mysql' since it's a public image
          docker compose build api

  ########################################
  #  CD Job: Deploy to Server on 'main'
  ########################################
  deploy:
    runs-on: ubuntu-latest
    # Only run this job for pushes to 'main'
    if: github.event_name == 'push'
    
    # This job must wait for 'build' to pass *if* it's a PR.
    # Since this job only runs on 'push', we can remove the 'needs'
    # or make it more complex. For simplicity, we'll keep them separate.
    
    steps:
      - name: SSH into server and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          
          # This is the script that runs on your server
          script: |
            # Go to the app's directory on the server
            cd ${{ secrets.SERVER_APP_PATH }}
            
            # Check for the .env file (critical for docker compose)
            if [ ! -f .env ]; then
              echo ".env file not found! Deployment failed."
              exit 1
            fi
            
            # Pull the latest code from the main branch
            echo "1. Pulling latest code..."
            git pull origin main
            
            # Pull latest base images (e.g., mysql:8.0)
            echo "2. Pulling latest base images..."
            docker compose pull
            
            # Re-build and re-start all services
            # --build: Rebuilds 'api' service because its code changed
            # -d: Runs in detached mode
            echo "3. Rebuilding and restarting services..."
            docker compose up -d --build
            
            # Clean up old, dangling images to save disk space
            echo "4. Pruning old Docker images..."
            docker image prune -f
            
            echo "âœ… Deployment successful!"